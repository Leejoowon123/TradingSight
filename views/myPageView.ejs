<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page</title>
    <link rel="stylesheet" href="../public/stylesheets/myPageStyles.css">
</head>

<body>
    <div class="card">
        <div class="card2">
            <form class="form" id="mainForm" action="/user/myPage/updateNewPassword" method="post" onsubmit="return handleFormSubmit(event)">
                <p id="heading">My Page</p>
                <label for="userId">
                    <p class="text-inline">사용자아이디 : </p> 
                    <p class="text-inline"><%= userId %></p>
                </label>
                
                <div id="passwordSection" class="field" style="display: none;">
                    <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon">
                        <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path>
                    </svg>
                    <input type="password" class="input-field" id="newPassword" placeholder="New Password" name="newPassword" required>
                </div>

                <div class="btn" id="initialButtons">
                    <button class="button1" type="button" id="changePasswordButton" onclick="showPasswordSection()">비밀번호 변경</button>
                    <button class="button3" type="button" id="deleteAccountButton" onclick="confirmDelete()">회원탈퇴</button>
                </div>

                <div class="btn" id="submitButton" style="display: none;">
                    <button class="button3" type="submit">변경하기</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../public/javascripts/myPageScripts.js"></script>
    <script>
        function showPasswordSection() {
            document.getElementById('passwordSection').style.display = 'flex';
            document.getElementById('initialButtons').style.display = 'none';
            document.getElementById('submitButton').style.display = 'flex';
        }

        function confirmDelete() {
            const confirmation = confirm("정말로 회원탈퇴를 하시겠습니까?");
            if (confirmation) {
                document.getElementById('deleteUserForm').submit();
            }
        }

        function handleFormSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const newPassword = document.getElementById('newPassword').value;

            // 비밀번호 조건 확인
            if (newPassword.length < 8) {
                alert("비밀번호는 최소 8자 이상이어야 합니다.");
                return false;
            }

            fetch(form.action, {
                method: form.method,
                body: new FormData(form),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("비밀번호가 변경되었습니다.");
                    window.location.reload(); // 비밀번호 변경 후 페이지 새로고침
                } else {
                    alert(`비밀번호 변경에 실패했습니다: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("비밀번호 변경에 실패했습니다. 다시 시도해주세요.");
            });
        }
    </script>
</body>

</html>
